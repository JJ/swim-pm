#!/usr/bin/env bash

set -e

rm -fr cpan
mkdir cpan

(
  set -x
  cp Changes cpan
  cp -r lib cpan
  [ -e bin ] && cp -r bin cpan
  [ -e eg ] && cp -r eg cpan
  cp -r test cpan/t
  rm -fr cpan/t/devel cpan/t/misc
  ./.cpan/bin/make-dist-ini > cpan/dist.ini
)

for swim in $(find doc -type f -name '*.swim'); do
  pod="${swim/doc/cpan/lib}"
  pod="${pod/.swim/.pod}"
  mkdir -p "$(dirname "$pod")"
  if grep '^====' "$swim" &> /dev/null; then
    (
      set -x
      swim --to=pod --pod-cpan "$swim" > "$pod"
    )
  else
    (
      set -x
      swim --to=pod --complete --wrap "$swim" > "$pod"
    )
  fi
done

# vim: set sw=2 lisp:
